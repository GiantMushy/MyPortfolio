name: Build and Deploy ASP.NET Core to GitHub Pages

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Restore dependencies
        run: dotnet restore

      - name: Build and generate static site
        run: |
          # Build the application
          dotnet build --configuration Release --no-restore
          
          # Create output directory
          mkdir -p dist
          
          # Copy static assets from wwwroot first
          cp -R wwwroot/* dist/
          
          # Set environment variables for production
          export ASPNETCORE_ENVIRONMENT=Production
          export ASPNETCORE_URLS="http://localhost:5000"
          export ASPNETCORE_LOGGING__LOGLEVEL__DEFAULT=Warning
          
          # Start the application in background
          echo "ğŸš€ Starting ASP.NET Core application..."
          dotnet run --configuration Release --no-build --no-launch-profile > app.log 2>&1 &
          APP_PID=$!
          
          echo "ğŸ“‹ Application PID: $APP_PID"
          
          # Wait for app to start with better error handling
          echo "â³ Waiting for application to start..."
          READY=false
          for i in {1..90}; do
            if curl -f -s http://localhost:5000/ > /dev/null 2>&1; then
              echo "âœ… Application is ready on port 5000!"
              READY=true
              break
            fi
            echo "â³ Attempt $i/90: Waiting for app..."
            
            # Check if process is still running
            if ! kill -0 $APP_PID 2>/dev/null; then
              echo "âŒ Application process died. Checking logs:"
              cat app.log
              exit 1
            fi
            
            sleep 2
          done
          
          if [ "$READY" = false ]; then
            echo "âŒ Application failed to start within 3 minutes. Checking logs:"
            cat app.log
            echo "ğŸ” Process status:"
            ps aux | grep dotnet || echo "No dotnet processes found"
            echo "ğŸŒ Network status:"
            netstat -tlnp | grep 5000 || echo "Port 5000 not in use"
            exit 1
          fi
          
          # Test the application response
          echo "ğŸ§ª Testing application response..."
          RESPONSE=$(curl -s -w "HTTP_CODE:%{http_code}" http://localhost:5000/)
          echo "Response: $RESPONSE"
          
          # Generate static HTML files
          echo "ğŸ”„ Generating static pages..."
          
          # Generate home page with detailed logging
          echo "ğŸ“„ Generating home page..."
          if curl -f -s -o dist/index.html http://localhost:5000/; then
            echo "âœ… Generated index.html ($(wc -c < dist/index.html) bytes)"
            echo "ğŸ” Preview of generated index.html:"
            head -20 dist/index.html
          else
            echo "âŒ Failed to generate index.html from ASP.NET app"
            echo "ğŸ“‹ Using fallback wwwroot/index.html"
            echo "ğŸ” Current dist/index.html content:"
            head -10 dist/index.html
          fi
          
          # Generate education page
          echo "ğŸ“„ Generating education page..."
          if curl -f -s -o dist/education.html http://localhost:5000/Education; then
            echo "âœ… Generated education.html ($(wc -c < dist/education.html) bytes)"
          else
            echo "âš ï¸  Education page not available"
            echo "ğŸ” Testing Education endpoint:"
            curl -v http://localhost:5000/Education || echo "Education endpoint failed"
          fi
          
          # Generate test page
          echo "ğŸ“„ Generating test page..."
          if curl -f -s -o dist/test.html http://localhost:5000/Test; then
            echo "âœ… Generated test.html ($(wc -c < dist/test.html) bytes)"
          else
            echo "âš ï¸  Test page not available"
            echo "ğŸ” Testing Test endpoint:"
            curl -v http://localhost:5000/Test || echo "Test endpoint failed"
          fi
          
          # Generate MyJourney page
          echo "ğŸ“„ Generating MyJourney page..."
          if curl -f -s -o dist/myjourney.html http://localhost:5000/Home/MyJourney; then
            echo "âœ… Generated myjourney.html ($(wc -c < dist/myjourney.html) bytes)"
          else
            echo "âš ï¸  MyJourney page not available"
            echo "ğŸ” Testing MyJourney endpoint:"
            curl -v http://localhost:5000/Home/MyJourney || echo "MyJourney endpoint failed"
          fi
          
          # Fix paths for GitHub Pages subdirectory deployment
          echo "ğŸ”§ Fixing asset paths for GitHub Pages..."
          find dist -name "*.html" -type f -exec sed -i 's|="/css/|="css/|g' {} \;
          find dist -name "*.html" -type f -exec sed -i 's|="/js/|="js/|g' {} \;
          find dist -name "*.html" -type f -exec sed -i 's|="/images/|="images/|g' {} \;
          find dist -name "*.html" -type f -exec sed -i 's|="/json/|="json/|g' {} \;
          find dist -name "*.html" -type f -exec sed -i 's|href="/|href="./|g' {} \;
          
          # Convert MVC routes to static HTML file links
          echo "ğŸ”§ Converting MVC routes to static HTML links..."
          find dist -name "*.html" -type f -exec sed -i 's|href="/Home/MyJourney"|href="myjourney.html"|g' {} \;
          find dist -name "*.html" -type f -exec sed -i 's|href="/Education"|href="education.html"|g' {} \;
          
          echo "âœ… Fixed asset paths to be relative"
          
          # Stop the application gracefully
          echo "ğŸ›‘ Stopping application..."
          kill -TERM $APP_PID 2>/dev/null || true
          sleep 2
          kill -KILL $APP_PID 2>/dev/null || true
          
          # Include custom domain if present
          if [ -f CNAME ]; then 
            cp CNAME dist/
            echo "âœ… Copied CNAME file"
          fi
          
          echo "ğŸ“ Final dist directory contents:"
          find dist -type f -exec ls -la {} \;
          
          echo "ğŸ” Checking generated HTML files:"
          for file in dist/*.html; do
            if [ -f "$file" ]; then
              echo "ğŸ“„ $file ($(wc -c < "$file") bytes):"
              head -10 "$file"
              echo "..."
            fi
          done

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: dist

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
