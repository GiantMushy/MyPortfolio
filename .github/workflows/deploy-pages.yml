name: Deploy static site to GitHub Pages

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Restore dependencies
        run: dotnet restore

      - name: Build and generate static site
        run: |
          # Build the application
          dotnet build --configuration Release --no-restore
          
          # Create output directory
          mkdir -p dist
          
          # Copy static assets from wwwroot first
          cp -R wwwroot/* dist/
          
          # Create a production launch settings for consistent port
          mkdir -p Properties
          cat > Properties/launchSettings.production.json << 'EOF'
          {
            "profiles": {
              "production": {
                "commandName": "Project",
                "dotnetRunMessages": false,
                "launchBrowser": false,
                "applicationUrl": "http://localhost:5000",
                "environmentVariables": {
                  "ASPNETCORE_ENVIRONMENT": "Production"
                }
              }
            }
          }
          EOF
          
          # Set environment variables for production
          export ASPNETCORE_ENVIRONMENT=Production
          export ASPNETCORE_URLS="http://localhost:5000"
          export ASPNETCORE_LOGGING__LOGLEVEL__DEFAULT=Error
          
          # Start the application in background with production settings
          echo "Starting ASP.NET Core application..."
          dotnet run --configuration Release --no-build --launch-profile production > app.log 2>&1 &
          APP_PID=$!
          
          # Wait for app to start with better error handling
          echo "Waiting for application to start..."
          READY=false
          for i in {1..60}; do
            if curl -f -s http://localhost:5000/ > /dev/null 2>&1; then
              echo "âœ… Application is ready on port 5000!"
              READY=true
              break
            fi
            echo "â³ Attempt $i/60: Waiting for app..."
            sleep 1
          done
          
          if [ "$READY" = false ]; then
            echo "âŒ Application failed to start. Checking logs:"
            cat app.log
            ps aux | grep dotnet
            exit 1
          fi
          
          # Generate static HTML files
          echo "ğŸ”„ Generating static pages..."
          
          # Generate home page
          if curl -f -s -o dist/index.html http://localhost:5000/; then
            echo "âœ… Generated index.html"
          else
            echo "âŒ Failed to generate index.html"
            echo "Using fallback wwwroot/index.html"
          fi
          
          # Generate education page
          if curl -f -s -o dist/education.html http://localhost:5000/Education; then
            echo "âœ… Generated education.html"
          else
            echo "âš ï¸  Education page not available"
          fi
          
          # Generate test page
          if curl -f -s -o dist/test.html http://localhost:5000/Test; then
            echo "âœ… Generated test.html"
          else
            echo "âš ï¸  Test page not available"
          fi
          
          # Stop the application gracefully
          echo "ğŸ›‘ Stopping application..."
          kill -TERM $APP_PID 2>/dev/null || true
          sleep 2
          kill -KILL $APP_PID 2>/dev/null || true
          
          # Include custom domain if present
          if [ -f CNAME ]; then 
            cp CNAME dist/
            echo "âœ… Copied CNAME file"
          fi
          
          echo "ğŸ“ Final dist directory contents:"
          find dist -type f -exec ls -la {} \;
          
          echo "ğŸ” Checking generated HTML files:"
          for file in dist/*.html; do
            if [ -f "$file" ]; then
              echo "ğŸ“„ $file ($(wc -c < "$file") bytes):"
              head -10 "$file"
              echo "..."
            fi
          done

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: dist

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
